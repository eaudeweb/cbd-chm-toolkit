<?php


/**
 * Preprocess theme_image().
 *
 * We use this preprocess to remove the itok param from the image url, when
 * insecure derivatives are allowed. We cannot use the preprocess of
 * theme_image_style(), as the itok is generated by image_style_url() in
 * theme_image_style() and therefore we cannot alter it directly in the image
 * style's theme processing.
 *
 * @see theme_image_style()
 */
function image_allow_insecure_derivatives_preprocess_image(&$vars) {
  // If there is really a path and the image is processed as image style, we
  // remove the ?tok=... part from the url.
  if (isset($vars['path']) && !empty($vars['style_name'])) {
    $vars['path'] = image_allow_insecure_derivatives_image_style_url_detok($vars['path']);
  }
}

/**
 * Remove image style itok from full url.
 *
 * @param string $uri
 *   URI that may contain itok.
 *
 * @return string
 *   URL without itok query param.
 */
function image_allow_insecure_derivatives_image_style_url_detok($uri) {
  // Do not change the url if insecure derivatives are not allowed.
  $insecure = variable_get('image_allow_insecure_derivatives', FALSE);
  if (!$insecure) {
    return $uri;
  }

  $parts = drupal_parse_url($uri);
  // We remove the itok from the query.
  if (isset($parts['query'][IMAGE_DERIVATIVE_TOKEN])) {
    unset($parts['query'][IMAGE_DERIVATIVE_TOKEN]);
  }
  // There should not be any fragment or query, so we simply can return the
  // already processed path.
  if (empty($uri['query']) && empty($uri['fragment'])) {
    return $parts['path'];
  }
  // Else build the path again.
  return url($parts['path'], $parts);
}

/**
 * @file
 * Image Allow Insecure Derivatives Drupal module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add the configuration toggle to the Image Toolkit settings.
 */
function image_allow_insecure_derivatives_form_system_image_toolkit_settings_alter(&$form, &$form_state, $form_id) {
  // The Image Allow Insecure Derivatives checkbox.
  $form['image_allow_insecure_derivatives'] = array(
    '#title' => t('Image Allow Insecure Derivatives'),
    '#type' => 'checkbox',
    '#description' => t('When enabled, will allow bypassing the token check when outputing image derivatives. Use this only if you are experiencing image display issues and understand the security risks.'),
    '#default_value' => variable_get('image_allow_insecure_derivatives', FALSE),
  );
}
